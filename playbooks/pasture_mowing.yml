---

- hosts: all
  gather_facts: false
  tasks:
    - name: Include vars
      include_vars:
        dir: "{{ working_dir }}/inventory/group_vars/all"

    - name: Validate request
      assert:
        that:
          - ansible_eda.event.meta.headers.Host == webhook_host
          - ansible_eda.event.meta.headers["x-from"] == webhook_x_from
          - ansible_eda.event.meta.source.name == webhook_source
          - ansible_eda.event.payload.from == webhook_payload_from


    - name: "Get email info for {{ emailId }}"
      vars:
        emailId: "{{ ansible_eda.event.payload.emailId }}"
      import_role:
        name: "{{ working_dir }}/roles/email_facts"

# Put this into a 'tasks/mowing_quote.yml' file and then trigger that call with 
# a when referencing the email_facts var

    - name: Make quote csv
      vars:
        equipment:
          mower: |-
            {%- set mowers = [] -%}
            {%- for mower in circlejh_equipment.mowers -%}
              {%- if (mower.min_acres < email_facts.acres < mower.max_acres) and
                     (mower.min_grass_height < email_facts.height < mower.max_grass_height) -%}
                {%- set _ = mowers.append(mower) -%}
              {%- endif -%}
            {%- endfor -%}
            {{ mowers|first }}
          truck: "{{ circlejh_equipment.truck }}"
          equipment_trailer: "{{ circlejh_equipment.trailer.equipment }}"
        project: |-
          {%- set hours = ( email_facts.acres / equipment.mower.acres_per_hour ) | round(0,'ceil') | int -%}
          {%- set days = ( hours / working_day_hours ) | round(0,'ceil') | int -%}
          {%- set weeks = ( days / 5 ) | round(0,'ceil') | int -%}
          {%- set project = {
            "hours": hours,
            "days": days,
            "weeks": weeks
            } -%}
          {{ project }} 
      template:
        src: "{{ working_dir }}/templates/mowing_quote.j2"
        dest: "{{ quote_path }}"

    - name: "Send {{ quote_path }} to slack"
      import_role:
        name: "{{ working_dir }}/roles/slack_update"
...
